 <html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jasa Cuci Kendaraan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    #overlay {
      background-color: rgba(0, 0, 0, 0.6);
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    .popup {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      max-width: 320px;
      width: 90vw;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      text-align: center;
      display: none;
      flex-direction: column;
      gap: 1rem;
    }
    #qrcode canvas {
      margin: 0 auto;
      display: block;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <header class="bg-blue-600 text-white p-4 text-center text-2xl font-semibold">
    Jasa Cuci Kendaraan
  </header>

  <main class="flex-grow container mx-auto p-4 max-w-lg">
    <div class="mb-4 border-b border-gray-300">
      <nav class="flex space-x-4" role="tablist" aria-label="Tabs">
        <button
          id="tab-harga"
          aria-controls="panel-harga"
          aria-selected="true"
          role="tab"
          type="button"
          class="py-2 px-4 text-blue-600 border-b-2 border-blue-600 font-semibold focus:outline-none"
        >
          Harga
        </button>
        <button
          id="tab-pembayaran"
          aria-controls="panel-pembayaran"
          aria-selected="false"
          role="tab"
          type="button"
          class="py-2 px-4 text-gray-600 border-b-2 border-transparent hover:text-blue-600 focus:outline-none"
        >
          Pembayaran
        </button>
      </nav>
    </div>

    <section
      id="panel-harga"
      role="tabpanel"
      tabindex="0"
      aria-labelledby="tab-harga"
      class=""
    >
      <div class="space-y-6">
        <div class="p-4 bg-white rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Cuci Motor</h3>
          <p class="text-gray-700 text-base">Harga: Rp 15.000</p>
        </div>
        <div class="p-4 bg-white rounded shadow">
          <h3 class="text-lg font-semibold mb-2">Cuci Mobil</h3>
          <p class="text-gray-700 text-base">Harga: Rp 25.000</p>
        </div>
      </div>
    </section>

    <section
      id="panel-pembayaran"
      role="tabpanel"
      tabindex="0"
      aria-labelledby="tab-pembayaran"
      class="hidden"
    >
      <form id="paymentForm" class="bg-white p-6 rounded shadow space-y-6" novalidate>
        <div>
          <label for="produk" class="block mb-1 font-medium text-gray-700"
            >Produk</label
          >
          <select
            id="produk"
            name="produk"
            required
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="" disabled selected>Pilih produk</option>
            <option value="Cuci Motor " data-price="15000"
              >Cuci Motor  - Rp 15.000</option
            >
            <option value="Cuci Mobil" data-price="25000"
              >Cuci Mobil - Rp 25.000</option
            >
          </select>
        </div>

        <div>
          <label for="totalOrder" class="block mb-1 font-medium text-gray-700"
            >Total Order</label
          >
          <input
            type="number"
            id="totalOrder"
            name="totalOrder"
            min="1"
            value="1"
            required
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label for="harga" class="block mb-1 font-medium text-gray-700"
            >Harga (Rp)</label
          >
          <input
            type="text"
            id="harga"
            name="harga"
            readonly
            class="w-full bg-gray-100 border border-gray-300 rounded px-3 py-2 cursor-not-allowed"
          />
        </div>

        <div>
          <label for="nama" class="block mb-1 font-medium text-gray-700"
            >Nama</label
          >
          <input
            type="text"
            id="nama"
            name="nama"
            placeholder="Masukkan nama Anda"
            required
            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <button
          type="submit"
          id="btnBayar"
          class="w-full bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700 transition"
        >
          Bayar
        </button>
      </form>
    </section>
  </main>

  <!-- QRIS Popup -->
  <div id="overlay" class="flex">
    <div class="popup" id="popupQris">
      <div id="qrcode"></div>
      <p id="paymentStatus" class="text-gray-700 font-medium">Menunggu pembayaran...</p>
      <button
        onclick="cancelPayment()"
        class="mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition"
      >
        Batalkan
      </button>
    </div>
  </div>

  <!-- Success Popup -->
  <div id="popupSuccess" class="popup">
    <p class="text-green-600 font-semibold text-lg">Pembayaran berhasil! ðŸŽ‰</p>
    <a href="#" id="joinGroupBtn" target="_blank" rel="noopener noreferrer">
      <button
        class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
      >
        Join Grup Telegram
      </button>
    </a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    // Tabs functionality
    const tabHarga = document.getElementById('tab-harga');
    const tabPembayaran = document.getElementById('tab-pembayaran');
    const panelHarga = document.getElementById('panel-harga');
    const panelPembayaran = document.getElementById('panel-pembayaran');

    tabHarga.addEventListener('click', () => {
      tabHarga.setAttribute('aria-selected', 'true');
      tabPembayaran.setAttribute('aria-selected', 'false');
      tabHarga.classList.add('text-blue-600', 'border-blue-600', 'font-semibold');
      tabHarga.classList.remove('text-gray-600', 'border-transparent');
      tabPembayaran.classList.remove('text-blue-600', 'border-blue-600', 'font-semibold');
      tabPembayaran.classList.add('text-gray-600', 'border-transparent');
      panelHarga.classList.remove('hidden');
      panelPembayaran.classList.add('hidden');
    });

    tabPembayaran.addEventListener('click', () => {
      tabPembayaran.setAttribute('aria-selected', 'true');
      tabHarga.setAttribute('aria-selected', 'false');
      tabPembayaran.classList.add('text-blue-600', 'border-blue-600', 'font-semibold');
      tabPembayaran.classList.remove('text-gray-600', 'border-transparent');
      tabHarga.classList.remove('text-blue-600', 'border-blue-600', 'font-semibold');
      tabHarga.classList.add('text-gray-600', 'border-transparent');
      panelPembayaran.classList.remove('hidden');
      panelHarga.classList.add('hidden');
    });

    // Elements for form and price calculation
    const produkSelect = document.getElementById('produk');
    const totalOrderInput = document.getElementById('totalOrder');
    const hargaInput = document.getElementById('harga');
    const namaInput = document.getElementById('nama');
    const paymentForm = document.getElementById('paymentForm');

    function updateHarga() {
      const selectedOption = produkSelect.options[produkSelect.selectedIndex];
      const price = selectedOption ? parseInt(selectedOption.dataset.price || '0', 10) : 0;
      const totalOrder = parseInt(totalOrderInput.value, 10) || 0;
      const totalPrice = price * totalOrder;
      hargaInput.value = totalPrice.toLocaleString('id-ID');
    }

    produkSelect.addEventListener('change', updateHarga);
    totalOrderInput.addEventListener('input', () => {
      if (totalOrderInput.value < 1) totalOrderInput.value = 1;
      updateHarga();
    });

    // Initialize harga on page load
    updateHarga();

    // Payment popup elements
    const overlay = document.getElementById('overlay');
    const popupQris = document.getElementById('popupQris');
    const paymentStatus = document.getElementById('paymentStatus');
    const popupSuccess = document.getElementById('popupSuccess');
    const joinGroupBtn = document.getElementById('joinGroupBtn');

    // Variables for payment process
    const botToken = '8178994002:AAGUXC44XiIMJCfdt0DcgJAGzMnexM15Jwo';
    const ownerId = '930068740';
    let settings = null;
    let checkInterval;
    let checkCount = 0;
    const maxChecks = 6;
    const intervalMs = 5 * 60 * 1000;
    let currentTrx = {};

    // Load settings from setting.json
    fetch('./settings.json')
      .then((res) => res.json())
      .then((data) => (settings = data))
      .catch(() => alert('Gagal memuat konfigurasi.'));

    function cancelPayment() {
      clearInterval(checkInterval);
      overlay.style.display = 'none';
      popupQris.style.display = 'none';
      paymentStatus.textContent = '';
    }

    async function checkPaymentStatus() {
      checkCount++;
      paymentStatus.textContent = `Mengecek status... (${checkCount * 5} menit)`;

      const cekUrl = `https://rikishopreal.my.id/orkut/cekstatus?apikey=${settings.apikey}&merchant=${settings.merchantIdOrderKuota}&keyorkut=${settings.apiOrderKuota}`;
      try {
        const res = await fetch(cekUrl);
        const json = await res.json();
        const status = json.status;

        if (['PAID', 'SUCCESS', 'SETTLEMENT'].includes(status)) {
          clearInterval(checkInterval);
          overlay.style.display = 'none';
          popupQris.style.display = 'none';
          showSuccessPopup();

          sendToTelegram(
            `âœ… Transaction Successful\nid: ${currentTrx.idTrx}\nuser: ${currentTrx.name}\ngoods: ${currentTrx.productName}\ntotal: Rp ${currentTrx.amount}\nstatus: ${status}`
          );
        } else if (['FAILED', 'EXPIRED'].includes(status)) {
          clearInterval(checkInterval);
          alert('Pembayaran gagal/expired.');
          cancelPayment();
        } else if (checkCount >= maxChecks) {
          clearInterval(checkInterval);
          alert('Waktu pembayaran habis.');
          cancelPayment();
        }
      } catch (err) {
        console.error(err);
      }
    }

    function showSuccessPopup() {
      popupSuccess.style.display = 'flex';
      overlay.style.display = 'flex';
      joinGroupBtn.href = settings.telegramGroupUrl || '#';
    }

    function sendToTelegram(message) {
      const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: ownerId, text: message }),
      });
    }

    paymentForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!settings) {
        alert('Konfigurasi belum siap.');
        return;
      }

      const productName = produkSelect.value;
      const price = parseInt(produkSelect.selectedOptions[0].dataset.price, 10);
      const totalOrder = parseInt(totalOrderInput.value, 10);
      const amount = price * totalOrder;
      const name = namaInput.value.trim();

      if (!productName || !totalOrder || !name) {
        alert('Mohon lengkapi semua data.');
        return;
      }

      const idTrx = 'TRX-' + Date.now();

      currentTrx = { idTrx, productName, amount, name };

      sendToTelegram(
        `ðŸ›’ New Buyer\nid: ${idTrx}\nuser: ${name}\nbuy goods: ${productName}\ntotal: Rp ${amount}\nstatus: pending`
      );

      const url = `https://rikishopreal.my.id/orkut/createpayment?apikey=${settings.apikey}&amount=${amount}&codeqr=${encodeURIComponent(
        settings.qrisOrderKuota
      )}`;

      try {
        const res = await fetch(url);
        const json = await res.json();
        if (!json.qr_url) throw new Error('QR URL not found');

        document.getElementById('qrcode').innerHTML = '';
        await QRCode.toCanvas(document.getElementById('qrcode'), json.qr_url, {
          width: 240,
        });

        overlay.style.display = 'flex';
        popupQris.style.display = 'flex';

        checkCount = 0;
        checkPaymentStatus();
        checkInterval = setInterval(checkPaymentStatus, intervalMs);
      } catch (e) {
        alert('Gagal membuat QRIS.');
        console.error(e);
      }
    });
  </script>
</body>
</html>
