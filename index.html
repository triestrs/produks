<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Jasa Cuci Kendaraan</title>
  <style>
    /* styling sederhana */
    body { font-family: sans-serif; margin: 20px; }
    .hidden { display: none; }
    #qr-canvas { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Jasa Cuci Kendaraan</h1>

  <form id="payment-form">
    <label>
      Produk:
      <select id="product">
        <option value="motor">Cuci Motor - Rp 15.000</option>
        <option value="mobil">Cuci Mobil - Rp 30.000</option>
      </select>
    </label>
    <br><br>
    <label>
      Total Order:
      <input id="quantity" type="number" min="1" value="1">
    </label>
    <br><br>
    <button type="submit">Bayar</button>
  </form>

  <canvas id="qr-canvas" class="hidden"></canvas>

  <script>
    let settings = null;

    // 1. Load konfigurasi QR-IS
    console.log('[QRIS] Memulai load settings.json…');
    fetch('/settings.json')
      .then(res => {
        console.log('[QRIS] settings.json HTTP status:', res.status);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        settings = data;
        console.log('[QRIS] settings berhasil dimuat:', settings);
      })
      .catch(err => {
        console.error('[QRIS] Gagal memuat settings.json:', err);
        alert('⚠️ Gagal memuat konfigurasi QR-IS. Lihat console untuk detail.');
      });

    // 2. Tangani submit form
    document.getElementById('payment-form').addEventListener('submit', async e => {
      e.preventDefault();

      if (!settings) {
        console.warn('[QRIS] settings masih null saat submit');
        alert('⚠️ Konfigurasi QR-IS belum siap. Lihat console.');
        return;
      }

      // Siapkan parameter request
      const product   = document.getElementById('product').value;
      const quantity  = +document.getElementById('quantity').value;
      const amount    = product === 'motor' ? 15000 * quantity : 30000 * quantity;
      const urlParams = new URLSearchParams({
        merchant: settings.merchantIdOrderKuota,
        apikey:   settings.apikey,
        sku:      settings.qrisOrderKuota,
        amount:   amount
      });
      const url = `https://rikishopreal.my.id/api/orkut/createpayment?${urlParams}`;

      console.log('[QRIS] URL createpayment:', url);

      try {
        const res = await fetch(url);
        console.log('[QRIS] createpayment HTTP status:', res.status);

        const json = await res.json();
        console.log('[QRIS] createpayment response JSON:', json);

        if (!json.qr_url) {
          throw new Error(json.message || 'qr_url tidak ditemukan');
        }

        // Render QR
        const canvas = document.getElementById('qr-canvas');
        canvas.classList.remove('hidden');
        QRCode.toCanvas(canvas, json.qr_url, err => {
          if (err) console.error('[QRIS] Error render QR:', err);
          else console.log('[QRIS] QR berhasil dirender');
        });

      } catch (err) {
        console.error('[QRIS] Error di createpayment:', err);
        alert(`⚠️ Gagal membuat QR-IS: ${err.message}`);
      }
    });
  </script>

  <!-- jangan lupa include QRCode.js atau library lain yang kamu gunakan -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
</body>
</html>
